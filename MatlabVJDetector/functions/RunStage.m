% RunStage

function result = RunStage(img, sc, theta)
global f;
count = size(sc,2);
%   img is the cropped image
%   f is the feature array
%   ix, iy is the point at which the classifier is ran
%   rect is [ix iy width height] and determines the subwindow

%   fArr contains the indices of the most effective features
%   thetaArr contains the corresponding thresholds
%   p contains the corresp parities
%   alpha cotains the corresp errors
%   the above values determine a classifier, that is used in the cascade
%   C {f_i, theta_i, p_i, alpha_i}

%fArr        = [     2.6119000000000000e+004  6.2680000000000000e+003  1.3761000000000000e+004  3.3455000000000000e+004  1.2457000000000000e+004  3.3935000000000000e+004  3.5989000000000000e+004  1.0194000000000000e+004  2.4004000000000000e+004  5.5330000000000000e+003  3.8612000000000000e+004  1.7415000000000000e+004  3.6304000000000000e+004  1.8790000000000000e+003  1.8641000000000000e+004  3.5999000000000000e+004  9.9060000000000000e+003  2.4298000000000000e+004  3.0047000000000000e+004  6.0710000000000000e+003  1.2545000000000000e+004  3.8690000000000000e+004  1.7247000000000000e+004  6.8680000000000000e+003  3.6709000000000000e+004  3.9021000000000000e+004  3.5464000000000000e+004  2.8648000000000000e+004  3.8339000000000000e+004  2.4709000000000000e+004  2.6470000000000000e+004  3.7217000000000000e+004  2.4546000000000000e+004  4.6180000000000000e+003  3.1515000000000000e+004  3.8576000000000000e+004  2.4452000000000000e+004  2.4767000000000000e+004  6.7610000000000000e+003  3.2590000000000000e+004  3.7531000000000000e+004  1.3754000000000000e+004  2.7132000000000000e+004  3.5924000000000000e+004  1.2537000000000000e+004  2.4534000000000000e+004  1.9876000000000000e+004  3.8854000000000000e+004  3.5060000000000000e+004  3.8993000000000000e+004  3.6608000000000000e+004  2.5014000000000000e+004  3.8178000000000000e+004  3.8044000000000000e+004  1.9434000000000000e+004  1.1000000000000000e+004  3.5380000000000000e+003  3.7530000000000000e+003  1.1550000000000000e+004  2.2537000000000000e+004  3.3003000000000000e+004  3.1838000000000000e+004  3.3484000000000000e+004  6.7180000000000000e+003  1.4750000000000000e+004  2.3485000000000000e+004  3.4749000000000000e+004  2.4678000000000000e+004  3.1917000000000000e+004  2.9556000000000000e+004];
%thetaArr    = [ -1.0155465676650735e+001 -1.8936474599824294e+001  3.2834624203801653e+001 -3.0999060152890019e+000 -2.2593462085551760e+001  1.1068054670150507e+000 -3.2623575502123909e+000  2.0517014973723455e+000  1.8015016397118515e+001  1.9409310707152020e+001 -9.4812455051708113e+000 -2.3289411039772880e+001  2.3323842142451021e+001  1.5879140253859354e+001 -3.0996556863971673e+001 -1.6093305576754773e+001  3.4657639368615598e+000  1.6184678529722593e+001  3.5125850564523375e+000  1.3955280014318774e+000  1.4554296103579935e+002 -1.8452720069765281e+001 -5.8857950013474408e+001 -2.0857643482891532e+000 -3.0363875949858059e+000  3.3352533997065335e+000  1.0339051177095516e+001  1.5712044137255077e+001  1.1052828398282781e+001  4.1129446076664451e+001 -1.8930304673739755e+000 -1.3086485773013361e+001 -1.8048114110989701e+001 -2.1111336259241742e+001  1.0304905498776765e+001 -9.0853864834140499e+000 -4.7996836981226892e+001  2.5419315004815495e+000 -2.0422824584723465e+000 -7.0116678686054659e+000 -1.2334596705630929e-001  3.2726963274345593e+000  2.7245123918626106e+000  1.0510924472985847e+001 -1.3334939211654878e+002  3.2038879802596547e+000 -1.8369129185770134e+001 -1.2059864922206541e+001  1.7330833836408495e+000  8.1613141074303996e+000  6.7130414359565336e+000  1.5858121792105724e+000  1.4351140336075876e+001 -1.6627539796217043e+001 -2.4730837769144813e+001  5.9759249623298594e-001  4.1809351682970162e+000 -1.7801249546729807e+001  2.4432233129245098e+001 -2.0592986356331672e+001 -1.1578165013910569e+001  1.6891144454509984e+001  3.3918304654146936e+000 -5.3539165588169961e+000  3.6943253870757317e+001 -1.3994020884354861e+000  2.9249218125598325e+001  5.5926039256824271e+000  1.1683205014744035e+001 -9.2823589888814340e-001];
%pArr        = [  1.0000000000000000e+000  1.0000000000000000e+000 -1.0000000000000000e+000  1.0000000000000000e+000  1.0000000000000000e+000 -1.0000000000000000e+000  1.0000000000000000e+000 -1.0000000000000000e+000 -1.0000000000000000e+000  1.0000000000000000e+000  1.0000000000000000e+000  1.0000000000000000e+000  1.0000000000000000e+000 -1.0000000000000000e+000  1.0000000000000000e+000 -1.0000000000000000e+000 -1.0000000000000000e+000 -1.0000000000000000e+000 -1.0000000000000000e+000  1.0000000000000000e+000 -1.0000000000000000e+000 -1.0000000000000000e+000  1.0000000000000000e+000  1.0000000000000000e+000  1.0000000000000000e+000 -1.0000000000000000e+000  1.0000000000000000e+000 -1.0000000000000000e+000  1.0000000000000000e+000 -1.0000000000000000e+000  1.0000000000000000e+000 -1.0000000000000000e+000  1.0000000000000000e+000 -1.0000000000000000e+000 -1.0000000000000000e+000 -1.0000000000000000e+000  1.0000000000000000e+000 -1.0000000000000000e+000  1.0000000000000000e+000  1.0000000000000000e+000  1.0000000000000000e+000 -1.0000000000000000e+000 -1.0000000000000000e+000  1.0000000000000000e+000  1.0000000000000000e+000 -1.0000000000000000e+000 -1.0000000000000000e+000  1.0000000000000000e+000 -1.0000000000000000e+000 -1.0000000000000000e+000  1.0000000000000000e+000 -1.0000000000000000e+000 -1.0000000000000000e+000 -1.0000000000000000e+000  1.0000000000000000e+000 -1.0000000000000000e+000 -1.0000000000000000e+000  1.0000000000000000e+000  1.0000000000000000e+000  1.0000000000000000e+000 -1.0000000000000000e+000 -1.0000000000000000e+000  1.0000000000000000e+000  1.0000000000000000e+000 -1.0000000000000000e+000  1.0000000000000000e+000  1.0000000000000000e+000 -1.0000000000000000e+000 -1.0000000000000000e+000  1.0000000000000000e+000];
%alphaArr    = [  1.5719428211550903e+000  1.4402006654867752e+000  1.2945518609237117e+000  1.0095697178860172e+000  8.0173080733942226e-001  7.7083452314947210e-001  6.5921268239183228e-001  5.6323189077305191e-001  5.9875332876099718e-001  6.2298762875652203e-001  6.0304365561462225e-001  5.6324567606151588e-001  5.3490067544536812e-001  5.6098844308891871e-001  5.4429486642465341e-001  6.1027710288749548e-001  4.7016425537687345e-001  4.6157745238030767e-001  4.4970410431901042e-001  4.6334950125912494e-001  4.9849910159327704e-001  4.3400772982248659e-001  5.0815870598674651e-001  4.7396585834668370e-001  4.2412671202164265e-001  4.0450065011358449e-001  4.2121040009389560e-001  4.8094017468909844e-001  4.0609529128296151e-001  4.3500609939392537e-001  4.1204915870181263e-001  3.9685578001167288e-001  4.1889627554123970e-001  3.7744810804131096e-001  4.0002016642494792e-001  3.2847206049090516e-001  4.3842188509039665e-001  3.8244558996847117e-001  3.5789345775322451e-001  3.6475406783927011e-001  3.6889799720536393e-001  3.8217778303253663e-001  3.3139122285110861e-001  3.2624478055023642e-001  3.7464352579180388e-001  3.6806346875350110e-001  3.6513053360099418e-001  3.7090254236035569e-001  3.9076231005197587e-001  3.6597516398936281e-001  3.6877131956239245e-001  3.3249652611696312e-001  3.0912147581535765e-001  3.9192082869260647e-001  3.5669784014771883e-001  3.4584409766997687e-001  3.1404750093486578e-001  3.6918769827222703e-001  3.5098370517848654e-001  3.8296399538749210e-001  3.1233816370877798e-001  3.5597892408511850e-001  3.3507042206724558e-001  3.2980196054056465e-001  3.3113070947139511e-001  3.4731311375031793e-001  3.5651302869295509e-001  3.5179285005002459e-001  3.3660256150813483e-001  3.2577048866007408e-001];
%global alphaArray;
%global thetaArray
%global fNbestArray;
%global pArray;
%global sc;
%fArr        = {fNbestArray(1:4), fNbestArray(5:15), fNbestArray(16:35)};%, fArr(1:20), fArr(1:40), fArr(1:70)};
%thetaArr = {thetaArray(1:4), thetaArray(5:15), thetaArray(16:35)};
%fArr = {fNbestArray(1:4), fN(5:15), fArr(16:35)};
%pArr = {pArray(1:4), pArray(5:15), pArray(16:35)};
%alphaArr = {alphaArray(1:4), alphaArray(4:15) alphaArray(16:35)};
%thetaArr    = {thetaArr(1:4), thetaArr(5:15), thetaArr(16:35)};%, thetaArr(1:20),thetaArr(1:40), thetaArr(1:70)};
%pArr       = {pArr(1:5), pArr(1:8)};%, pArr(1:20), pArr(1:40), pArr(1:70)};
%alphaArr    = {alphaArr(1:5), alphaArr(1:8)};%, alphaArr(1:20), alphaArr(1:40), alphaArr(1:70)};
%fArr = fNbestArray;
%thetaArr = thetaBestArray;
%pArr = pBestArray;
%aphaArr = alpha_t_Array;
% classifier count in the consequent stages


    clsf=0;
    sum=0;

        stage_sum=0;
        global f_res;
        global img_res;
        img_res = [];
        for stage_count=1:count
           scT = sc(stage_count);
            h=ApplyClassifier(f(:,scT.f),img,scT.theta,scT.p);
            if(h>0)
               stage_sum = stage_sum + scT.alpha*h;
           end
           %img_res = [img_res f_res];
           %sum = sum+scT.alpha;    
           
         end % end looping through the classifiers in the stage
       % sum
       % stage_sum
        if stage_sum >theta
            % since all the classifiers agreed that this region is a face +
            % then we can put it in the rect sequence for further analysis
            % and removal of the overlapping regions, etc.
            result=1;
         
        else
%           fprintf('dropped!');
            result=-1;
            return;
        end

